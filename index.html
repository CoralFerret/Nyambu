<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Be My Valentine üíò</title>
  <style>
    :root{
      --pink:#ff4da6;
      --soft:#fff0f7;
      --text:#222;
      --yes:#28a745;
      --no:#dc3545;
      --dark:#111;
      --muted:#6b6b6b;
      --card:#ffffffee;
      --border: rgba(255,77,166,0.18);
      --shadow: 0 12px 40px rgba(0,0,0,0.10);
    }
    *{ box-sizing:border-box; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, var(--soft), #ffffff);
      margin:0;
      min-height:100vh;
      min-height:100svh;
      display:grid;
      place-items:center;
      color:var(--text);
      overflow:hidden;
      padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom));
    }
    #confettiCanvas{
      position:fixed; inset:0;
      z-index:5;
      pointer-events:none;
    }
    .card{
      width:min(680px, 94vw);
      background: var(--card);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:26px 22px;
      text-align:center;
      position:relative;
      z-index:2;
      backdrop-filter: blur(6px);
    }
    h1{
      margin:0 0 8px;
      color:var(--pink);
      font-size:28px;
      letter-spacing:-0.2px;
    }
    p{
      margin:8px 0 14px;
      line-height:1.45;
      font-size:16px;
    }
    .subtle{
      font-size:14px;
      color: var(--muted);
      margin-top:2px;
    }
    .row{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .button{
      padding:14px 22px;
      font-size:18px;
      cursor:pointer;
      border:0;
      border-radius:14px;
      transition: transform .15s ease, box-shadow .15s ease;
      color:white;
      min-width:150px;
      box-shadow:0 10px 20px rgba(0,0,0,0.12);
      touch-action: manipulation;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .button:active{ transform: translateY(1px) scale(0.99); }
    #yesButton{ background:var(--yes); }
    #noButton{ background:var(--no); }
    #noButton:focus{ outline: 3px solid rgba(220,53,69,0.25); outline-offset: 2px; }

    .hidden{ display:none; }

    .panel{
      text-align:left;
      margin-top:14px;
      background:#fff;
      border-radius:16px;
      padding:14px 14px;
      border:1px solid var(--border);
    }
    .badge{
      display:inline-block;
      background: rgba(255,77,166,0.12);
      color: var(--pink);
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      margin-bottom:10px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){
      .grid{ grid-template-columns: 1fr; }
    }
    label{
      font-size:13px;
      opacity:0.85;
      display:block;
      margin-bottom:6px;
    }
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.12);
      font-size:15px;
      outline:none;
    }
    input:focus{
      border-color: rgba(255,77,166,0.5);
      box-shadow: 0 0 0 3px rgba(255,77,166,0.12);
    }

    .miniRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:12px;
    }
    .miniBtn{
      background: var(--dark);
      color:white;
      border:0;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-size:14px;
      touch-action: manipulation;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .plan{
      text-align:left;
      background:#fff;
      border-radius:16px;
      padding:16px 16px;
      border:1px solid var(--border);
      margin-top:14px;
    }
    .plan h2{
      margin:6px 0 10px;
      color:var(--pink);
      font-size:20px;
    }
    .footerNote{
      margin-top:10px;
      font-size:14px;
      color: #333;
    }

    .linkBox{
      margin-top:10px;
      text-align:left;
      background: rgba(0,0,0,0.03);
      border:1px dashed rgba(0,0,0,0.18);
      border-radius:14px;
      padding:12px 12px;
      word-break: break-all;
      font-size:13px;
    }

    .divider{
      height:1px;
      background: rgba(0,0,0,0.08);
      margin: 12px 0;
      border-radius: 999px;
    }

    /* Activity picker */
    .choicesHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 8px;
    }
    .counter{
      font-size:13px;
      color: var(--muted);
      background: rgba(0,0,0,0.04);
      padding:6px 10px;
      border-radius:999px;
    }
    .chips{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){
      .chips{ grid-template-columns: 1fr; }
    }
    .chip{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border:1px solid rgba(0,0,0,0.10);
      border-radius:14px;
      background: #fff;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .chip:active{ transform: scale(0.99); }
    .chip input{ width:18px; height:18px; }
    .chip b{ font-size:14px; }
    .chip small{ display:block; font-size:12px; color: var(--muted); margin-top:2px; }
    .chip.selected{
      border-color: rgba(255,77,166,0.55);
      box-shadow: 0 0 0 3px rgba(255,77,166,0.10);
    }

    /* Floating hearts */
    .heart{
      position:fixed;
      bottom:-40px;
      opacity:0.70;
      animation: floatUp linear forwards;
      z-index:1;
      pointer-events:none;
    }
    @keyframes floatUp{
      to{ transform: translateY(-110vh); opacity:0; }
    }

    /* Tiny toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: max(14px, env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(17,17,17,0.92);
      color: white;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>
  <canvas id="confettiCanvas"></canvas>
  <div class="toast" id="toast"></div>

  <!-- Setup / personalization -->
  <div class="card" id="setupCard">
    <h1>Valentine Invite üíò</h1>
    <p class="subtle">Fill this in once, then share the link on WhatsApp or email.</p>

    <div class="panel">
      <div class="badge">Personalize it</div>
      <div class="grid">
        <div>
          <label for="yourName">Your name</label>
          <input id="yourName" placeholder="e.g., Malcolm" autocomplete="name" />
        </div>
        <div>
          <label for="herName">Her name</label>
          <input id="herName" placeholder="e.g., Joanne" autocomplete="nickname" />
        </div>
        <div>
          <label for="datePick">Pick the date</label>
          <input id="datePick" type="date" />
        </div>
        <div>
          <label for="timePick">Pick a time (optional)</label>
          <input id="timePick" type="time" />
        </div>
      </div>

      <div class="miniRow">
        <button class="miniBtn" id="applyBtn">Generate my share link üîó</button>
        <button class="miniBtn" id="goBtn">Preview the page üëÄ</button>
      </div>

      <div class="linkBox" id="shareLinkBox" style="display:none;"></div>

      <div class="miniRow" id="shareButtons" style="display:none;">
        <button class="miniBtn" id="copyLink">Copy link</button>
        <button class="miniBtn" id="copyWhatsApp">Copy WhatsApp message</button>
      </div>

      <div class="divider"></div>
      <p class="subtle" style="margin:0;">
        Tip: This page must be hosted (GitHub Pages / Netlify / Vercel) so the link works on her phone. If you just open the file on your phone, the link can‚Äôt be shared reliably.
      </p>
    </div>
  </div>

  <!-- Question -->
  <div class="card hidden" id="questionCard">
    <h1 id="headline">Will you be my Valentine? üíò</h1>
    <p id="introLine">I have something special for you‚Ä¶</p>
    <p class="subtle" id="dateLine"></p>

    <div class="row">
      <button id="yesButton" class="button">YES! üòç</button>
      <button id="noButton" class="button" aria-label="No">NO üôà</button>
    </div>

    <div class="miniRow" style="margin-top:14px;">
      <button class="miniBtn" id="backToSetup">Edit names/date ‚úçÔ∏è</button>
    </div>

    <p class="subtle" style="margin-top:10px;">(Try pressing NO‚Ä¶ if you can üòÑ)</p>
  </div>

  <!-- Plan + choices -->
  <div class="card hidden" id="planCard">
    <h1 id="yesTitle">You said YES!! ü•∞üéâ</h1>
    <p id="yesSubtitle">Okay madam‚Ä¶ pick up to 3 things you want us to do üòÑ</p>

    <div class="plan">
      <div class="choicesHeader">
        <div class="badge">Pick up to 3 activities</div>
        <div class="counter" id="pickCounter">0 / 3 selected</div>
      </div>

      <div class="chips" id="choices"></div>

      <div class="divider"></div>

      <div class="badge">Send it back</div>
      <p style="margin-top:6px;margin-bottom:10px;">
        When you're done, tap <b>Send my picks</b> and it will create a link you can WhatsApp back.
      </p>

      <div class="linkBox" id="replyLinkBox" style="display:none;"></div>

      <div class="miniRow" style="justify-content:flex-start;">
        <button class="miniBtn" id="sendPicks" disabled>Send my picks üíå</button>
        <button class="miniBtn" id="copyReplyLink" style="display:none;">Copy reply link</button>
        <button class="miniBtn" id="whatsAppReply" style="display:none;">Send on WhatsApp</button>
      </div>

      <p class="subtle" id="limitHint" style="margin-top:10px;"></p>
    </div>

    <div class="miniRow">
      <button class="miniBtn" id="confettiAgain">More confetti üéä</button>
      <button class="miniBtn" id="restart">Back</button>
    </div>
  </div>

  <!-- Received reply view (when YOU open her link) -->
  <div class="card hidden" id="replyViewCard">
    <h1>Her answer üíå</h1>
    <p id="replySummary" style="margin-bottom:10px;"></p>
    <div class="plan">
      <div class="badge">Her picks</div>
      <ul id="replyList" style="margin:10px 0 0 18px; padding:0;"></ul>
    </div>
    <div class="miniRow">
      <button class="miniBtn" id="backHome">Back</button>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const qs = (s) => document.querySelector(s);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    function toast(msg){
      const el = qs("#toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.remove("show"), 1500);
    }

    function formatDate(dateStr){
      if(!dateStr) return "";
      const [y,m,d] = dateStr.split("-").map(Number);
      if(!y || !m || !d) return "";
      const dt = new Date(Date.UTC(y, m-1, d));
      return dt.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
    }

    function encodeParams(obj){
      const p = new URLSearchParams();
      Object.entries(obj).forEach(([k,v]) => {
        if(v !== undefined && v !== null && String(v).length) p.set(k, v);
      });
      return p.toString();
    }

    function getParams(){
      const p = new URLSearchParams(location.search);
      return {
        you: p.get("you") || "",
        her: p.get("her") || "",
        date: p.get("date") || "",
        time: p.get("time") || "",
        accepted: p.get("yes") || "",           // "1" means she said yes
        picks: p.get("picks") || ""             // comma separated keys
      };
    }

    function baseUrl(){
      // Works hosted; also tolerates local file:// where location.origin is "null"
      const href = location.href;
      return href.split("?")[0].split("#")[0];
    }

    function buildShareUrl(obj){
      const query = encodeParams(obj);
      return query ? `${baseUrl()}?${query}` : baseUrl();
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        toast("Copied ‚úÖ");
        return true;
      }catch{
        // fallback prompt is more reliable on mobile than alert for long strings
        prompt("Copy this:", text);
        return false;
      }
    }

    // ---------- State ----------
    const setupCard = qs("#setupCard");
    const questionCard = qs("#questionCard");
    const planCard = qs("#planCard");
    const replyViewCard = qs("#replyViewCard");

    const yourNameInput = qs("#yourName");
    const herNameInput = qs("#herName");
    const datePick = qs("#datePick");
    const timePick = qs("#timePick");

    const shareLinkBox = qs("#shareLinkBox");
    const shareButtons = qs("#shareButtons");

    const headline = qs("#headline");
    const introLine = qs("#introLine");
    const dateLine = qs("#dateLine");
    const yesTitle = qs("#yesTitle");
    const yesSubtitle = qs("#yesSubtitle");

    function applyPersonalization(you, her, date, time){
      const herClean = her?.trim() || "my love";
      const youClean = you?.trim() || "me";
      const prettyDate = formatDate(date);
      const timeText = time ? ` at ${time}` : "";

      headline.textContent = `${herClean}, will you be my Valentine? üíò`;
      introLine.textContent = `From ${youClean} to ${herClean}‚Ä¶ I have something special for you üòå`;
      dateLine.textContent = prettyDate ? `Proposed date: ${prettyDate}${timeText}` : "";

      yesTitle.textContent = `Yesss ${herClean}!! ü•∞üéâ`;
      yesSubtitle.textContent = `Alright ${herClean}‚Ä¶ pick up to 3 things you want us to do üòÑ`;
    }

    function showSetup(){ setupCard.classList.remove("hidden"); questionCard.classList.add("hidden"); planCard.classList.add("hidden"); replyViewCard.classList.add("hidden"); }
    function showQuestion(){ setupCard.classList.add("hidden"); questionCard.classList.remove("hidden"); planCard.classList.add("hidden"); replyViewCard.classList.add("hidden"); }
    function showPlan(){ setupCard.classList.add("hidden"); questionCard.classList.add("hidden"); planCard.classList.remove("hidden"); replyViewCard.classList.add("hidden"); }
    function showReplyView(){ setupCard.classList.add("hidden"); questionCard.classList.add("hidden"); planCard.classList.add("hidden"); replyViewCard.classList.remove("hidden"); }

    // ---------- Activity options (max 3) ----------
    const OPTIONS = [
      { key:"stayc",  title:"Staycation üè®",        desc:"Cozy hotel/Airbnb vibes" },
      { key:"dinner", title:"Dinner date üçù",       desc:"Nice spot + dessert" },
      { key:"movie",  title:"Movies üé¨",            desc:"Cinema or home" },
      { key:"bond",   title:"Bonding ü•∞",           desc:"Talk + games + laughs" },
      { key:"order",  title:"Order-in üçï",          desc:"Food delivery + chill" },
      { key:"home",   title:"Stay home üõãÔ∏è",        desc:"Blankets + snacks" },
      { key:"drive",  title:"Night drive üöó‚ú®",     desc:"Music + city lights" },
      { key:"pic",    title:"Cute photos üì∏üíñ",     desc:"Make memories" }
    ];
    const MAX_PICKS = 3;

    const choicesWrap = qs("#choices");
    const pickCounter = qs("#pickCounter");
    const sendPicksBtn = qs("#sendPicks");
    const limitHint = qs("#limitHint");
    const replyLinkBox = qs("#replyLinkBox");
    const copyReplyLinkBtn = qs("#copyReplyLink");
    const whatsAppReplyBtn = qs("#whatsAppReply");

    const picked = new Set();

    function renderChoices(){
      choicesWrap.innerHTML = "";
      for(const opt of OPTIONS){
        const row = document.createElement("label");
        row.className = "chip";
        row.setAttribute("data-key", opt.key);
        row.innerHTML = `
          <input type="checkbox" aria-label="${opt.title}">
          <div>
            <b>${opt.title}</b>
            <small>${opt.desc}</small>
          </div>
        `;
        row.addEventListener("click", (e)=>{
          // ensure tap toggles checkbox cleanly
          if(e.target.tagName.toLowerCase() !== "input"){
            const cb = row.querySelector("input");
            cb.checked = !cb.checked;
          }
          const cb = row.querySelector("input");
          togglePick(opt.key, cb.checked, row);
        });
        choicesWrap.appendChild(row);
      }
      syncPickUI();
    }

    function togglePick(key, shouldPick, rowEl){
      if(shouldPick){
        if(picked.size >= MAX_PICKS){
          // revert
          const cb = rowEl?.querySelector("input");
          if(cb) cb.checked = false;
          toast(`Max ${MAX_PICKS} picks üòÑ`);
          limitHint.textContent = `You can only choose up to ${MAX_PICKS}. Uncheck one to pick another.`;
          return;
        }
        picked.add(key);
      }else{
        picked.delete(key);
      }
      limitHint.textContent = "";
      syncPickUI();
    }

    function syncPickUI(){
      // highlight selected rows
      choicesWrap.querySelectorAll(".chip").forEach(el=>{
        const key = el.getAttribute("data-key");
        const isOn = picked.has(key);
        el.classList.toggle("selected", isOn);
        const cb = el.querySelector("input");
        cb.checked = isOn;
      });
      pickCounter.textContent = `${picked.size} / ${MAX_PICKS} selected`;
      sendPicksBtn.disabled = picked.size === 0;
    }

    function picksToText(keys){
      const map = new Map(OPTIONS.map(o=>[o.key, o.title]));
      return keys.map(k=> map.get(k) || k);
    }

    // ---------- Initial load from URL params ----------
    (function initFromUrl(){
      const {you, her, date, time, accepted, picks} = getParams();

      // Prefill setup for edits
      yourNameInput.value = you;
      herNameInput.value = her;
      datePick.value = date;
      timePick.value = time;

      applyPersonalization(you, her, date, time);
      renderChoices();

      // If you (Malcolm) open her reply link, show the reply summary view
      if(accepted === "1"){
        const keys = picks ? picks.split(",").filter(Boolean) : [];
        const list = qs("#replyList");
        const summary = qs("#replySummary");

        const herClean = (her || "her").trim();
        const youClean = (you || "you").trim();
        const prettyDate = formatDate(date);
        const timeText = time ? ` at ${time}` : "";

        summary.textContent = `${herClean} said YES üíò and chose:`;
        list.innerHTML = "";
        const items = picksToText(keys);
        if(items.length){
          for(const t of items){
            const li = document.createElement("li");
            li.textContent = t;
            list.appendChild(li);
          }
        }else{
          const li = document.createElement("li");
          li.textContent = "(No activities selected)";
          list.appendChild(li);
        }

        // Little extra context line
        if(prettyDate){
          const li = document.createElement("li");
          li.textContent = `Date: ${prettyDate}${timeText}`;
          list.appendChild(li);
        }
        const li2 = document.createElement("li");
        li2.textContent = `From: ${herClean} ‚Üí ${youClean}`;
        list.appendChild(li2);

        showReplyView();
        spawnHearts(12);
        startConfetti(1200);
        return;
      }

      // Normal behavior
      if(you || her || date || time){
        showQuestion();
      }else{
        showSetup();
      }
    })();

    // ---------- Setup actions ----------
    function syncUrlToInputs(){
      const you = yourNameInput.value.trim();
      const her = herNameInput.value.trim();
      const date = datePick.value;
      const time = timePick.value;

      const query = encodeParams({you, her, date, time});
      const newUrl = query ? `${location.pathname}?${query}` : location.pathname;
      history.replaceState({}, "", newUrl);
      return {you, her, date, time};
    }

    qs("#applyBtn").addEventListener("click", () => {
      const {you, her, date, time} = syncUrlToInputs();
      applyPersonalization(you, her, date, time);

      const url = buildShareUrl({you, her, date, time});
      shareLinkBox.style.display = "block";
      shareButtons.style.display = "flex";
      shareLinkBox.textContent = url;
      toast("Link generated üîó");
    });

    qs("#goBtn").addEventListener("click", () => {
      const {you, her, date, time} = syncUrlToInputs();
      applyPersonalization(you, her, date, time);
      showQuestion();
    });

    qs("#copyLink").addEventListener("click", async () => {
      const you = yourNameInput.value.trim();
      const her = herNameInput.value.trim();
      const date = datePick.value;
      const time = timePick.value;
      const url = buildShareUrl({you, her, date, time});
      await copyText(url);
    });

    qs("#copyWhatsApp").addEventListener("click", async () => {
      const you = yourNameInput.value.trim() || "Me";
      const her = herNameInput.value.trim() || "babe";
      const date = datePick.value;
      const time = timePick.value;
      const prettyDate = formatDate(date);
      const timeText = time ? ` at ${time}` : "";
      const url = buildShareUrl({you: yourNameInput.value.trim(), her: herNameInput.value.trim(), date, time});

      const msg = `Hey ${her} üòåüíò\nI made something for you.\nWill you be my Valentine?\n${prettyDate ? `Date: ${prettyDate}${timeText}\n` : ""}${url}`;
      await copyText(msg);
    });

    qs("#backToSetup").addEventListener("click", showSetup);
    qs("#backHome").addEventListener("click", () => {
      // Remove yes/picks if present
      const {you, her, date, time} = getParams();
      history.replaceState({}, "", buildShareUrl({you, her, date, time}));
      showQuestion();
    });

    // ---------- Elusive NO (mobile-friendly) ----------
    const noButton = qs("#noButton");
    function dodge(){
      const pad = 14;
      const btnRect = noButton.getBoundingClientRect();
      const btnW = btnRect.width || 170;
      const btnH = btnRect.height || 64;

      const maxX = Math.max(pad, window.innerWidth - btnW - pad);
      const maxY = Math.max(pad, window.innerHeight - btnH - pad);

      const x = Math.floor(Math.random() * (maxX - pad + 1)) + pad;
      const y = Math.floor(Math.random() * (maxY - pad + 1)) + pad;

      noButton.style.position = "fixed";
      noButton.style.left = x + "px";
      noButton.style.top = y + "px";
      noButton.style.zIndex = 10;
    }

    // Pointer events cover mouse + touch
    noButton.addEventListener("pointerenter", dodge);
    noButton.addEventListener("pointerdown", (e) => { e.preventDefault(); dodge(); });
    noButton.addEventListener("touchstart", (e) => { e.preventDefault(); dodge(); }, {passive:false});

    // ---------- YES -> plan + confetti ----------
    qs("#yesButton").addEventListener("click", () => {
      showPlan();
      startConfetti(1600);
      spawnHearts(18);
    });

    qs("#restart").addEventListener("click", () => {
      // keep personalization; go back to question
      showQuestion();
    });

    qs("#confettiAgain").addEventListener("click", () => {
      startConfetti(1200);
      spawnHearts(12);
    });

    // ---------- "Send back" link creation ----------
    qs("#sendPicks").addEventListener("click", () => {
      const {you, her, date, time} = getParams();
      const keys = Array.from(picked);
      const replyUrl = buildShareUrl({you, her, date, time, yes:"1", picks: keys.join(",")});

      replyLinkBox.style.display = "block";
      replyLinkBox.textContent = replyUrl;

      copyReplyLinkBtn.style.display = "inline-block";
      whatsAppReplyBtn.style.display = "inline-block";

      toast("Reply link ready üíå");
    });

    copyReplyLinkBtn.addEventListener("click", async () => {
      const text = replyLinkBox.textContent.trim();
      if(text) await copyText(text);
    });

    whatsAppReplyBtn.addEventListener("click", () => {
      const {you, her, date, time} = getParams();
      const herClean = (her || "babe").trim();
      const youClean = (you || "you").trim();
      const prettyDate = formatDate(date);
      const timeText = time ? ` at ${time}` : "";
      const chosen = picksToText(Array.from(picked)).join(", ");
      const link = replyLinkBox.textContent.trim();

      const msg = `Yesss ${youClean} üòçüíò\nMy picks: ${chosen}${prettyDate ? `\nDate: ${prettyDate}${timeText}` : ""}\n${link}`;
      // Open WhatsApp with prefilled text
      const wa = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(wa, "_blank");
    });

    // ---------- Confetti (no libraries) ----------
    const canvas = qs("#confettiCanvas");
    const ctx = canvas.getContext("2d", { alpha: true });
    let pieces = [];
    let running = false;
    const palette = ["#ff4da6","#ffcc00","#00c2ff","#7c4dff","#00d084","#ff6b6b"];

    function resize(){
      const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize);
    resize();

    function rand(min,max){ return Math.random()*(max-min)+min; }

    function makePiece(){
      return {
        x: rand(0, window.innerWidth),
        y: rand(-30, -window.innerHeight*0.4),
        w: rand(6, 12),
        h: rand(8, 16),
        vx: rand(-2.6, 2.6),
        vy: rand(3.6, 7.8),
        rot: rand(0, Math.PI*2),
        vr: rand(-0.16, 0.16),
        a: 1,
        fade: rand(0.004, 0.012),
        color: palette[(Math.random()*palette.length)|0]
      };
    }

    function draw(p){
      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    }

    function step(){
      if(!running) return;
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

      for(const p of pieces){
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        p.a = Math.max(0, p.a - p.fade);

        if(p.x < -20) p.x = window.innerWidth + 20;
        if(p.x > window.innerWidth + 20) p.x = -20;

        draw(p);
      }

      pieces = pieces.filter(p => p.a > 0 && p.y < window.innerHeight + 50);

      if(pieces.length){
        requestAnimationFrame(step);
      } else {
        running = false;
        ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      }
    }

    function startConfetti(duration=1300){
      pieces = Array.from({length: 160}, makePiece);
      running = true;
      step();

      const start = performance.now();
      function add(t){
        if(t - start < duration){
          pieces.push(...Array.from({length: 10}, makePiece));
          requestAnimationFrame(add);
        }
      }
      requestAnimationFrame(add);
    }

    // ---------- Floating hearts ----------
    function spawnHearts(n=12){
      const hearts = ["üíñ","üíï","üíò","üíó","üíû","‚ù§Ô∏è"];
      for(let i=0;i<n;i++){
        const el = document.createElement("div");
        el.className = "heart";
        el.textContent = hearts[(Math.random()*hearts.length)|0];
        el.style.left = Math.floor(Math.random()*window.innerWidth) + "px";
        el.style.animationDuration = (Math.random()*2.4 + 3.2).toFixed(2) + "s";
        el.style.fontSize = (Math.random()*18 + 14).toFixed(0) + "px";
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 6500);
      }
    }
  </script>
</body>
</html>
